<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WaveSpeed Pro</title>

<style>
/* ‚ö†Ô∏è DESIGN UNTOUCHED */
:root {
    --bg:#0f172a;--card:#1e293b;--text:#f1f5f9;
    --accent:#3b82f6;--accent-hover:#60a5fa;
    --input-bg:#334155;--border:#475569;
}
body{margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;justify-content:center;align-items:center}
.app-container{width:90%;max-width:850px;height:95vh;background:var(--card);border-radius:20px;box-shadow:0 25px 50px -12px rgba(0,0,0,.7);display:flex;flex-direction:column;overflow:hidden;border:1px solid var(--border)}
.header{padding:25px;background:rgba(15,23,42,.8);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:15px}
.controls-row{display:flex;gap:15px}
.nice-input{flex:1;background:var(--input-bg);border:2px solid var(--border);padding:15px;border-radius:12px;color:#fff;font-size:.95rem;outline:none;transition:.3s}
.nice-input:hover{border-color:var(--accent-hover);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.3)}
.nice-input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(59,130,246,.2)}
.chat-area{flex:1;padding:20px;overflow-y:auto;background:radial-gradient(circle,#243045,#1e293b);display:flex;flex-direction:column;gap:15px}
.message{max-width:80%;padding:14px 18px;border-radius:16px;line-height:1.6;animation:popIn .3s ease-out}
@keyframes popIn{from{opacity:0;transform:translateY(5px)}to{opacity:1}}
.ai{align-self:flex-start;background:var(--input-bg);border:1px solid var(--border)}
.user{align-self:flex-end;background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
.error{align-self:center;background:#ef4444;color:#fff}
.bottom-bar{padding:20px;background:var(--card);border-top:1px solid var(--border);display:flex;gap:15px}
.prompt-input{flex:1;padding:15px;border-radius:12px;background:var(--bg);border:1px solid var(--border);color:#fff}
.send-btn{background:var(--accent);color:#fff;border:none;padding:0 30px;border-radius:12px;font-weight:700;cursor:pointer;transition:.3s}
.send-btn:hover{background:var(--accent-hover);transform:translateY(-3px) scale(1.02)}
.send-btn:disabled{background:var(--border);cursor:not-allowed}
.timer{font-size:.8rem;background:#fbbf24;color:#000;padding:2px 6px;border-radius:4px;margin-left:6px}

/* Helper for upload label alignment */
.upload-label { cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: #aaa; }
.upload-label:hover { color: #fff; }
</style>
</head>

<body>
<div class="app-container">

<div class="header">
    <div class="controls-row">
        <input id="linkInput" class="nice-input" value="https://api.wavespeed.ai/api/v3/google/nano-banana-pro/edit">
        <input id="keyInput" class="nice-input" type="password" placeholder="API Key">
    </div>

    <div class="controls-row">
        <input id="imgInput" class="nice-input" placeholder="Image URL (optional)">
        
        <label class="nice-input upload-label">
            <span id="fileName">üìÇ Upload</span>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </label>

        <select id="aspect" class="nice-input">
            <option value="1:1">1:1</option>
            <option value="16:9">16:9</option>
            <option value="9:16">9:16</option>
        </select>
    </div>

    <div class="controls-row">
        <select id="resolution" class="nice-input">
            <option value="1k">1K</option>
            <option value="2k">2K</option>
        </select>
        <select id="format" class="nice-input">
            <option value="png">PNG</option>
            <option value="jpg">JPG</option>
            <option value="webp">WEBP</option>
        </select>
    </div>
</div>

<div class="chat-area" id="chat">
    <div class="message ai"><b>System Online (Local Mode).</b></div>
</div>

<div class="bottom-bar">
    <input id="userInput" class="prompt-input" placeholder="Type instruction...">
    <button id="sendBtn" class="send-btn">SEND</button>
</div>

</div>

<script>
// --- ELEMENTS ---
const chat = document.getElementById("chat");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const fileName = document.getElementById("fileName");
const imgInput = document.getElementById("imgInput");
const keyInput = document.getElementById("keyInput");
const linkInput = document.getElementById("linkInput");
const userInput = document.getElementById("userInput");
const aspect = document.getElementById("aspect");
const resolution = document.getElementById("resolution");
const format = document.getElementById("format");

// ‚úÖ LOCALHOST (PowerShell Logs)
const API = "https://wavespeedapp-api-7ce9.onrender.com/generate";

// UI: Show selected filename
fileInput.addEventListener('change', function() {
    if(this.files && this.files[0]) {
        fileName.innerText = "‚úÖ " + this.files[0].name.substring(0, 12) + "...";
        fileName.style.color = "#fff";
    } else {
        fileName.innerText = "üìÇ Upload";
        fileName.style.color = "#aaa";
    }
});

function msg(html,type="ai"){
    const d=document.createElement("div");
    d.className=`message ${type}`;d.innerHTML=html;
    chat.appendChild(d);chat.scrollTop=chat.scrollHeight;return d;
}

// Helper: Convert File to Clean Base64 (No Header)
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
        let res = reader.result;
        // Important: Remove the "data:image/png;base64," prefix
        if(res.includes("base64,")) {
            res = res.split("base64,")[1];
        }
        resolve(res);
    };
    reader.onerror = error => reject(error);
});

sendBtn.onclick = async () => {
    const prompt = userInput.value.trim();
    if(!prompt) return alert("Please enter a prompt!");
    if(!keyInput.value) return alert("Please enter your API Key!");

    // --- CHECK FOR IMAGE ---
    let finalImage = imgInput.value.trim();
    if(fileInput.files.length > 0) {
        finalImage = await toBase64(fileInput.files[0]);
    }

    if(!finalImage) {
        return alert("‚ùå ERROR: You must either upload an image or paste an Image URL for this prompt!");
    }

    sendBtn.disabled = true;
    msg(prompt,"user");
    const loader = msg(`Loading <span class="timer">0s</span>`);

    let sec=0;
    const t=setInterval(()=>loader.querySelector(".timer").innerText=++sec+"s",1000);

    try{
        const res = await fetch(API,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                apiKey:keyInput.value,
                apiUrl:linkInput.value,
                payload:{
                    prompt,
                    images: [finalImage], // Send array with confirmed image
                    aspect_ratio: aspect.value,
                    resolution: resolution.value,
                    output_format: format.value,
                    enable_base64_output:true
                }
            })
        });

        clearInterval(t);
        const data = await res.json();

        if(data.error) throw new Error(data.error);

        // Handle Image Output
        if(data.outputs?.[0]?.data){
            loader.innerHTML = `<img style="max-width:100%;border-radius:12px"
            src="data:image/png;base64,${data.outputs[0].data}">`;
        } else {
            console.log("Full Response:", data);
            loader.innerText = "Job finished but output format was unexpected. Check Console.";
        }

    }catch(e){
        clearInterval(t);
        loader.className="message error";
        loader.innerText=e.message;
    }
    sendBtn.disabled=false;
};
</script>
</body>
</html>